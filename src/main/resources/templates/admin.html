<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        color: #333;
    }
    .container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2 {
        color: #0056b3;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .logout-button {
        background-color: #dc3545;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
    }
    .logout-button:hover {
        background-color: #c82333;
    }
    .message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
    }
    .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="welcomeMessage">Admin Dashboard</h1>
    <button class="logout-button" id="logoutButton">Logout</button>
  </div>

  <div id="adminContent">
    <h2>All Users</h2>
    <div id="usersMessage" class="message"></div>
    <table id="usersTable">
      <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Roles</th>
      </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <hr style="margin: 30px 0;">

    <h2>All Accounts</h2>
    <div id="accountsMessage" class="message"></div>
    <table id="accountsTable">
      <thead>
      <tr>
        <th>ID</th>
        <th>Account Number</th>
        <th>Type</th>
        <th>Balance</th>
        <th>Owner (Username)</th>
      </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>

<script>
  const backendUrl = 'http://localhost:8083';
  const welcomeMessage = document.getElementById('welcomeMessage');
  const logoutButton = document.getElementById('logoutButton');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const accountsTableBody = document.querySelector('#accountsTable tbody');
  const usersMessage = document.getElementById('usersMessage');
  const accountsMessage = document.getElementById('accountsMessage');

  // --- Authentication Check and Page Setup ---
  document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username');
      const jwtToken = localStorage.getItem('jwtToken');
      const userRoles = JSON.parse(localStorage.getItem('userRoles') || '[]'); // Get roles from localStorage

      if (!jwtToken || !username) {
          alert('Session expired or unauthorized. Please log in again.');
          window.location.href = '/login';
          return;
      }

      // Important: Check if the user has ADMIN role
      if (!userRoles.includes('ROLE_ADMIN')) {
          alert('Access Denied: You do not have administrator privileges.');
          window.location.href = '/dashboard'; // Redirect to regular dashboard or login
          return;
      }

      welcomeMessage.textContent = `Admin Dashboard - Welcome, ${username}!`;
      fetchAllUsers();
      fetchAllAccounts();
  });

  logoutButton.addEventListener('click', () => {
      localStorage.removeItem('jwtToken');
      localStorage.removeItem('username');
      localStorage.removeItem('userRoles'); // Clear roles too
      window.location.href = '/login';
  });

  // --- Helper function to display messages ---
  function displayMessage(element, message, type) {
      element.textContent = message;
      element.className = `message ${type}`;
      setTimeout(() => {
          element.textContent = '';
          element.className = 'message';
      }, 5000); // Clear message after 5 seconds
  }

  // --- Fetch All Users Function ---
  async function fetchAllUsers() {
      usersTableBody.innerHTML = ''; // Clear previous users
      usersMessage.textContent = '';

      const jwtToken = localStorage.getItem('jwtToken');

      try {
          const response = await fetch(`${backendUrl}/api/admin/users`, {
              method: 'GET',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              }
          });

          if (response.ok) {
              const users = await response.json();
              if (users.length === 0) {
                  displayMessage(usersMessage, 'No users found in the system.', 'info');
              } else {
                  users.forEach(user => {
                      const row = usersTableBody.insertRow();
                      row.insertCell(0).textContent = user.id;
                      row.insertCell(1).textContent = user.username;
                      row.insertCell(2).textContent = user.email;
                      // Display roles as a comma-separated string
                      const rolesCell = row.insertCell(3);
                      if (user.roles && user.roles.length > 0) {
                          rolesCell.textContent = user.roles.map(role => role.name).join(', ');
                      } else {
                          rolesCell.textContent = 'N/A';
                      }
                  });
                  displayMessage(usersMessage, `Showing ${users.length} users.`, 'success');
              }
          } else if (response.status === 401) {
              displayMessage(usersMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              localStorage.removeItem('userRoles');
              setTimeout(() => window.location.href = '/login', 1500);
          } else if (response.status === 403) {
              displayMessage(usersMessage, 'Access Denied: You do not have permission to view users.', 'error');
          } else {
              const errorData = await response.json();
              displayMessage(usersMessage, `Error fetching users: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error fetching users:', error);
          displayMessage(usersMessage, 'Network error or unable to connect to server.', 'error');
      }
  }

  // --- Fetch All Accounts Function ---
  async function fetchAllAccounts() {
      accountsTableBody.innerHTML = ''; // Clear previous accounts
      accountsMessage.textContent = '';

      const jwtToken = localStorage.getItem('jwtToken');

      try {
          const response = await fetch(`${backendUrl}/api/admin/accounts`, {
              method: 'GET',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              }
          });

          if (response.ok) {
              const accounts = await response.json();
              if (accounts.length === 0) {
                  displayMessage(accountsMessage, 'No accounts found in the system.', 'info');
              } else {
                  accounts.forEach(account => {
                      const row = accountsTableBody.insertRow();
                      row.insertCell(0).textContent = account.id;
                      row.insertCell(1).textContent = account.accountNumber;
                      row.insertCell(2).textContent = account.accountType;
                      row.insertCell(3).textContent = `$${parseFloat(account.balance).toFixed(2)}`;
                      // Assuming 'user' object is populated in the account response
                      row.insertCell(4).textContent = account.user ? account.user.username : 'N/A';
                  });
                  displayMessage(accountsMessage, `Showing ${accounts.length} accounts.`, 'success');
              }
          } else if (response.status === 401) {
              displayMessage(accountsMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              localStorage.removeItem('userRoles');
              setTimeout(() => window.location.href = '/login', 1500);
          } else if (response.status === 403) {
              displayMessage(accountsMessage, 'Access Denied: You do not have permission to view accounts.', 'error');
          } else {
              const errorData = await response.json();
              displayMessage(accountsMessage, `Error fetching accounts: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error fetching accounts:', error);
          displayMessage(accountsMessage, 'Network error or unable to connect to server.', 'error');
      }
  }
</script>
</body>
</html>