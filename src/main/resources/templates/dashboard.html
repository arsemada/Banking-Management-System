<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        color: #333;
    }
    .container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
        color: #0056b3;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .logout-button {
        background-color: #dc3545;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
    }
    .logout-button:hover {
        background-color: #c82333;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group select, .form-group input[type="text"], .form-group input[type="number"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box; /* Ensures padding doesn't increase width */
    }
    .btn {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
    }
    .btn:hover {
        background-color: #0056b3;
    }
    .message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
    }
    .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .account-list {
        list-style: none;
        padding: 0;
    }
    .account-item {
        background-color: #e9ecef;
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .account-item strong {
        color: #0056b3;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 id="welcomeMessage">Welcome, !</h1>
    <button class="logout-button" id="logoutButton">Logout</button>
  </div>

  <div id="dashboardContent">
    <h2>Create New Account</h2>
    <form id="createAccountForm">
      <div class="form-group">
        <label for="accountType">Account Type:</label>
        <select id="accountType" name="accountType" required>
          <option value="">Select Type</option>
          <option value="SAVINGS">Savings</option>
          <option value="CHECKING">Checking</option>
        </select>
      </div>
      <div class="form-group">
        <label for="initialBalance">Initial Balance:</label>
        <input type="number" id="initialBalance" name="initialBalance" step="0.01" value="0.00" required>
      </div>
      <button type="submit" class="btn">Create Account</button>
      <div id="createAccountMessage" class="message"></div>
    </form>

    <hr style="margin: 30px 0;">

    <h2>Your Accounts</h2>
    <ul id="accountsList" class="account-list">
    </ul>
    <div id="accountsMessage" class="message"></div>

    <hr style="margin: 30px 0;">

    <h2>Deposit Funds</h2>
    <form id="depositForm">
      <div class="form-group">
        <label for="depositAccountId">Select Account:</label>
        <select id="depositAccountId" required>
          <option value="">Loading accounts...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="depositAmount">Amount:</label>
        <input type="number" id="depositAmount" step="0.01" min="0.01" required>
      </div>
      <button type="submit" class="btn">Deposit</button>
      <div id="depositMessage" class="message"></div>
    </form>

    <hr style="margin: 30px 0;">

    <h2>Withdraw Funds</h2>
    <form id="withdrawForm">
      <div class="form-group">
        <label for="withdrawAccountId">Select Account:</label>
        <select id="withdrawAccountId" required>
          <option value="">Loading accounts...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="withdrawAmount">Amount:</label>
        <input type="number" id="withdrawAmount" step="0.01" min="0.01" required>
      </div>
      <button type="submit" class="btn">Withdraw</button>
      <div id="withdrawMessage" class="message"></div>
    </form>

    <hr style="margin: 30px 0;">

    <h2>Transfer Funds</h2>
    <form id="transferForm">
      <div class="form-group">
        <label for="fromAccountId">From Account:</label>
        <select id="fromAccountId" required>
          <option value="">Loading accounts...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="toAccountNumber">To Account Number:</label>
        <input type="text" id="toAccountNumber" placeholder="Enter recipient's account number" required>
      </div>
      <div class="form-group">
        <label for="transferAmount">Amount:</label>
        <input type="number" id="transferAmount" step="0.01" min="0.01" required>
      </div>
      <button type="submit" class="btn">Transfer</button>
      <div id="transferMessage" class="message"></div>
    </form>

    <hr style="margin: 30px 0;">

    <h3>Recent Transactions (Coming Soon)</h3>
    <div id="transactionsList"></div>

  </div>
</div>

<script>
  const backendUrl = 'http://localhost:8083';
  const welcomeMessage = document.getElementById('welcomeMessage');
  const logoutButton = document.getElementById('logoutButton');
  const createAccountForm = document.getElementById('createAccountForm');
  const createAccountMessage = document.getElementById('createAccountMessage');
  const accountsList = document.getElementById('accountsList');
  const accountsMessage = document.getElementById('accountsMessage');

  // Elements for Deposit
  const depositForm = document.getElementById('depositForm');
  const depositAccountIdSelect = document.getElementById('depositAccountId');
  const depositAmountInput = document.getElementById('depositAmount');
  const depositMessage = document.getElementById('depositMessage');

  // Elements for Withdrawal
  const withdrawForm = document.getElementById('withdrawForm');
  const withdrawAccountIdSelect = document.getElementById('withdrawAccountId');
  const withdrawAmountInput = document.getElementById('withdrawAmount');
  const withdrawMessage = document.getElementById('withdrawMessage');

  // New elements for Transfer
  const transferForm = document.getElementById('transferForm');
  const fromAccountIdSelect = document.getElementById('fromAccountId');
  const toAccountNumberInput = document.getElementById('toAccountNumber');
  const transferAmountInput = document.getElementById('transferAmount');
  const transferMessage = document.getElementById('transferMessage');


  // --- Authentication Check and Page Setup ---
  document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username');
      const jwtToken = localStorage.getItem('jwtToken');

      if (!jwtToken || !username) {
          alert('Session expired or unauthorized. Please log in again.');
          window.location.href = '/login';
          return;
      }

      welcomeMessage.textContent = `Welcome, ${username}!`;
      fetchAccounts(); // Load accounts when dashboard loads
  });

  logoutButton.addEventListener('click', () => {
      localStorage.removeItem('jwtToken');
      localStorage.removeItem('username');
      window.location.href = '/login';
  });

  // --- Helper function to display messages ---
  function displayMessage(element, message, type) {
      element.textContent = message;
      element.className = `message ${type}`;
      setTimeout(() => {
          element.textContent = '';
          element.className = 'message';
      }, 5000); // Clear message after 5 seconds
  }

  // --- Fetch Accounts Function ---
  async function fetchAccounts() {
      accountsList.innerHTML = ''; // Clear previous accounts
      accountsMessage.textContent = '';

      // Clear and reset dropdowns for accounts (for all forms)
      depositAccountIdSelect.innerHTML = '<option value="">Loading accounts...</option>';
      withdrawAccountIdSelect.innerHTML = '<option value="">Loading accounts...</option>';
      fromAccountIdSelect.innerHTML = '<option value="">Loading accounts...</option>'; // For transfer form

      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
          displayMessage(accountsMessage, 'Authentication token missing. Please log in.', 'error');
          return;
      }

      try {
          const response = await fetch(`${backendUrl}/api/accounts`, {
              method: 'GET',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              }
          });

          if (response.ok) {
              const accounts = await response.json();
              if (accounts.length === 0) {
                  displayMessage(accountsMessage, 'You have no accounts yet. Create one above!', 'info');
                  // Clear and populate dropdowns with default "No accounts" option
                  depositAccountIdSelect.innerHTML = '<option value="">No accounts available</option>';
                  withdrawAccountIdSelect.innerHTML = '<option value="">No accounts available</option>';
                  fromAccountIdSelect.innerHTML = '<option value="">No accounts available</option>'; // For transfer form
              } else {
                  // Temporary arrays to hold options before adding default prepended options
                  const depositOptions = [];
                  const withdrawOptions = [];
                  const transferFromOptions = [];

                  accounts.forEach(account => {
                      const li = document.createElement('li');
                      li.className = 'account-item';
                      li.innerHTML = `
                          <div>
                              <strong>${account.accountType} Account (Number: ${account.accountNumber}):</strong><br>
                              Balance: $${parseFloat(account.balance).toFixed(2)}
                          </div>
                      `;
                      accountsList.appendChild(li);

                      const option = document.createElement('option');
                      option.value = account.id; // Use account ID as the value
                      option.textContent = `${account.accountType} (${account.accountNumber}) - $${parseFloat(account.balance).toFixed(2)}`;

                      // Push clones to temporary arrays
                      depositOptions.push(option.cloneNode(true));
                      withdrawOptions.push(option.cloneNode(true));
                      transferFromOptions.push(option.cloneNode(true));
                  });

                  // Add default "Select Account" option and then append real options
                  const defaultDepositOption = document.createElement('option');
                  defaultDepositOption.value = ""; defaultDepositOption.textContent = "Select Account"; defaultDepositOption.selected = true; defaultDepositOption.disabled = true;
                  depositAccountIdSelect.appendChild(defaultDepositOption);
                  depositOptions.forEach(opt => depositAccountIdSelect.appendChild(opt));

                  const defaultWithdrawOption = document.createElement('option');
                  defaultWithdrawOption.value = ""; defaultWithdrawOption.textContent = "Select Account"; defaultWithdrawOption.selected = true; defaultWithdrawOption.disabled = true;
                  withdrawAccountIdSelect.appendChild(defaultWithdrawOption);
                  withdrawOptions.forEach(opt => withdrawAccountIdSelect.appendChild(opt));

                  const defaultTransferFromOption = document.createElement('option');
                  defaultTransferFromOption.value = ""; defaultTransferFromOption.textContent = "Select Account"; defaultTransferFromOption.selected = true; defaultTransferFromOption.disabled = true;
                  fromAccountIdSelect.appendChild(defaultTransferFromOption);
                  transferFromOptions.forEach(opt => fromAccountIdSelect.appendChild(opt));

              }
          } else if (response.status === 401) {
              displayMessage(accountsMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              setTimeout(() => window.location.href = '/login', 1500);
          } else {
              const errorData = await response.json();
              displayMessage(accountsMessage, `Error fetching accounts: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error fetching accounts:', error);
          displayMessage(accountsMessage, 'Network error or unable to connect to server.', 'error');
      }
  }

  // --- Create Account Form Submission ---
  createAccountForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      createAccountMessage.textContent = ''; // Clear previous messages

      const accountType = document.getElementById('accountType').value;
      const initialBalance = parseFloat(document.getElementById('initialBalance').value);

      if (!accountType) {
          displayMessage(createAccountMessage, 'Please select an account type.', 'error');
          return;
      }
      if (isNaN(initialBalance) || initialBalance < 0) {
          displayMessage(createAccountMessage, 'Please enter a valid positive initial balance.', 'error');
          return;
      }

      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
          displayMessage(createAccountMessage, 'Authentication token missing. Please log in.', 'error');
          return;
      }

      try {
          const response = await fetch(`${backendUrl}/api/accounts`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ accountType, initialBalance })
          });

          if (response.ok) {
              const newAccount = await response.json();
              displayMessage(createAccountMessage, `Account created successfully! ${newAccount.accountType} (${newAccount.accountNumber})`, 'success');
              createAccountForm.reset(); // Clear form
              fetchAccounts(); // Refresh the list of accounts
          } else if (response.status === 401) {
              displayMessage(createAccountMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              setTimeout(() => window.location.href = '/login', 1500);
          }
          else {
              const errorData = await response.json();
              displayMessage(createAccountMessage, `Error creating account: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error creating account:', error);
          displayMessage(createAccountMessage, 'Network error or unable to connect to server.', 'error');
      }
  });

  // --- Deposit Form Submission ---
  depositForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      depositMessage.textContent = '';

      const accountId = depositAccountIdSelect.value;
      const amount = parseFloat(depositAmountInput.value);

      if (!accountId) {
          displayMessage(depositMessage, 'Please select an account.', 'error');
          return;
      }
      if (isNaN(amount) || amount <= 0) {
          displayMessage(depositMessage, 'Please enter a positive amount to deposit.', 'error');
          return;
      }

      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
          displayMessage(depositMessage, 'Authentication token missing. Please log in.', 'error');
          return;
      }

      try {
          const response = await fetch(`${backendUrl}/api/accounts/${accountId}/deposit`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ amount })
          });

          if (response.ok) {
              const updatedAccount = await response.json();
              displayMessage(depositMessage, `Deposit of $${amount.toFixed(2)} successful to ${updatedAccount.accountNumber}! New balance: $${parseFloat(updatedAccount.balance).toFixed(2)}`, 'success');
              depositForm.reset();
              fetchAccounts(); // Refresh account list and balances
          } else if (response.status === 401) {
              displayMessage(depositMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              setTimeout(() => window.location.href = '/login', 1500);
          } else {
              const errorData = await response.json();
              displayMessage(depositMessage, `Deposit failed: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error during deposit:', error);
          displayMessage(depositMessage, 'Network error or unable to connect to server.', 'error');
      }
  });

  // --- Withdrawal Form Submission ---
  withdrawForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      withdrawMessage.textContent = '';

      const accountId = withdrawAccountIdSelect.value;
      const amount = parseFloat(withdrawAmountInput.value);

      if (!accountId) {
          displayMessage(withdrawMessage, 'Please select an account.', 'error');
          return;
      }
      if (isNaN(amount) || amount <= 0) {
          displayMessage(withdrawMessage, 'Please enter a positive amount to withdraw.', 'error');
          return;
      }

      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
          displayMessage(withdrawMessage, 'Authentication token missing. Please log in.', 'error');
          return;
      }

      try {
          const response = await fetch(`${backendUrl}/api/accounts/${accountId}/withdraw`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ amount })
          });

          if (response.ok) {
              const updatedAccount = await response.json();
              displayMessage(withdrawMessage, `Withdrawal of $${amount.toFixed(2)} successful from ${updatedAccount.accountNumber}! New balance: $${parseFloat(updatedAccount.balance).toFixed(2)}`, 'success');
              withdrawForm.reset();
              fetchAccounts(); // Refresh account list and balances
          } else if (response.status === 401) {
              displayMessage(withdrawMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              setTimeout(() => window.location.href = '/login', 1500);
          } else {
              const errorData = await response.json();
              displayMessage(withdrawMessage, `Withdrawal failed: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error during withdrawal:', error);
          displayMessage(withdrawMessage, 'Network error or unable to connect to server.', 'error');
      }
  });

  // --- Transfer Form Submission ---
  transferForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      transferMessage.textContent = '';

      const fromAccountId = fromAccountIdSelect.value;
      const toAccountNumber = toAccountNumberInput.value.trim();
      const amount = parseFloat(transferAmountInput.value);

      if (!fromAccountId) {
          displayMessage(transferMessage, 'Please select your source account.', 'error');
          return;
      }
      if (!toAccountNumber) {
          displayMessage(transferMessage, 'Please enter the recipient\'s account number.', 'error');
          return;
      }
      if (isNaN(amount) || amount <= 0) {
          displayMessage(transferMessage, 'Please enter a positive amount to transfer.', 'error');
          return;
      }

      const jwtToken = localStorage.getItem('jwtToken');
      if (!jwtToken) {
          displayMessage(transferMessage, 'Authentication token missing. Please log in.', 'error');
          return;
      }

      try {
          const response = await fetch(`${backendUrl}/api/accounts/transfer`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${jwtToken}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ fromAccountId, toAccountNumber, amount })
          });

          if (response.ok) {
              const successData = await response.json(); // Expecting a MessageResponse
              displayMessage(transferMessage, `Transfer successful: ${successData.message}`, 'success');
              transferForm.reset();
              fetchAccounts(); // Refresh account list and balances
          } else if (response.status === 401) {
              displayMessage(transferMessage, 'Session expired or unauthorized. Please log in again.', 'error');
              localStorage.removeItem('jwtToken');
              localStorage.removeItem('username');
              setTimeout(() => window.location.href = '/login', 1500);
          } else {
              const errorData = await response.json();
              displayMessage(transferMessage, `Transfer failed: ${errorData.message || response.statusText}`, 'error');
          }
      } catch (error) {
          console.error('Error during transfer:', error);
          displayMessage(transferMessage, 'Network error or unable to connect to server.', 'error');
      }
  });

</script>
</body>
</html>